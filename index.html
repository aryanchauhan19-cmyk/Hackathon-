<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>TwinX Delhi | Policy Sandbox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/TextPlugin.min.js"></script>
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>

    <style>
        /* --- GLOBAL THEME --- */
        :root { 
            --neon-cyan: #00f2ff; 
            --neon-red: #ff003c;
            --neon-green: #00ff88;
            --glass-bg: rgba(20, 25, 40, 0.75);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #050a10; font-family: 'Rajdhani', sans-serif; color: var(--text-main); cursor: none; }
        
        /* Cursor */
        #cursor { position: fixed; top: 0; left: 0; width: 40px; height: 40px; border: 2px solid var(--neon-cyan); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 10000; box-shadow: 0 0 15px var(--neon-cyan); transition: width 0.2s, height 0.2s; mix-blend-mode: difference; }
        #cursor::after { content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border-top: 2px solid var(--neon-cyan); border-bottom: 2px solid var(--neon-cyan); border-radius: 50%; transform: translate(-50%, -50%); animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* --- LANDING & FOG ANIMATION --- */
        #landing-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: linear-gradient(to bottom, #1a1f24, #0d1216); display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        
        /* THE FOG EFFECT */
        .fog-container { position: absolute; width: 100%; height: 100%; top: 0; left: 0; overflow: hidden; z-index: 1; }
        .fog-img {
            position: absolute; height: 100vh; width: 300vw;
            background: url('https://raw.githubusercontent.com/danielstuart14/CSS_FOG_ANIMATION/master/fog1.png') repeat-x;
            background-size: contain; animation: fogAnim 60s linear infinite;
        }
        .fog-img-2 {
            position: absolute; height: 100vh; width: 300vw;
            background: url('https://raw.githubusercontent.com/danielstuart14/CSS_FOG_ANIMATION/master/fog2.png') repeat-x;
            background-size: contain; animation: fogAnim 40s linear infinite reverse;
            z-index: 2; opacity: 0.5;
        }
        @keyframes fogAnim { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-200vw, 0, 0); } }

        .landing-ui { z-index: 10; text-align: center; position: relative; }
        .main-header { font-family: 'Orbitron'; font-size: 80px; color: #fff; letter-spacing: -2px; margin-bottom: 40px; filter: blur(8px); transition: filter 0.5s ease; }
        .main-header:hover { filter: blur(0px); text-shadow: 0 0 30px var(--neon-cyan); }
        .init-btn { background: rgba(0,0,0,0.5); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 15px 40px; font-family: 'Rajdhani'; font-size: 18px; font-weight: 700; cursor: pointer; letter-spacing: 2px; backdrop-filter: blur(5px); }
        .init-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 30px var(--neon-cyan); }
        
        .loader-container { width: 300px; display: none; z-index: 20; margin-top: 30px; }
        .loader-bar { width: 100%; height: 2px; background: #333; }
        .loader-progress { height: 100%; width: 0%; background: var(--neon-cyan); }
        .boot-text { color: var(--neon-green); font-size: 12px; margin-top: 10px; text-align: center; font-family: 'Orbitron'; }

        /* --- TOP NAV & BUTTONS --- */
        .top-nav { position: fixed; top: 20px; left: 20px; z-index: 1000; display: flex; gap: 10px; }
        .nav-btn {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); color: #fff;
            padding: 12px 25px; border-radius: 30px; cursor: pointer;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 14px;
            display: flex; align-items: center; gap: 10px; transition: 0.3s;
        }
        .nav-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); }
        .nav-btn.cost-btn { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        .nav-btn.cost-btn:hover { background: var(--neon-yellow); color: #000; }

        /* --- AUDIT MODAL --- */
        #auditModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        .audit-paper {
            background: #fdfdfd; color: #222;
            width: 600px; max-height: 90vh; overflow-y: auto;
            padding: 50px; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            font-family: 'Courier Prime', monospace;
            position: relative; transform: rotate(-1deg);
            border: 1px solid #ccc;
        }
        .audit-paper::before {
            content: 'CONFIDENTIAL'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px; color: rgba(255,0,0,0.08);
            font-weight: bold; pointer-events: none; border: 8px solid rgba(255,0,0,0.08); padding: 20px;
        }
        .audit-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
        .audit-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 20px; }
        .audit-table th { text-align: left; border-bottom: 2px solid #000; padding: 10px 5px; font-weight: bold; }
        .audit-table td { padding: 10px 5px; border-bottom: 1px dotted #999; }
        .audit-total { font-weight: bold; font-size: 20px; border-top: 2px solid #000; margin-top: 20px; padding-top: 15px; display: flex; justify-content: space-between; }
        .audit-status { margin-top: 25px; padding: 15px; border: 2px solid #000; text-align: center; font-weight: bold; background: #eee; }
        .close-audit { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 28px; color: #000; font-weight: bold; }
        .close-audit:hover { color: red; }

        /* Left Panel */
        #dashboard-panel { position: absolute; top: 100px; left: 20px; bottom: 20px; width: 350px; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 20px; z-index: 100; display: flex; flex-direction: column; transform: translateX(-150%); }
        .panel-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .panel-title { font-family: 'Orbitron'; font-size: 18px; color: var(--neon-cyan); margin: 0; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }

        /* AQI Gauge */
        .aqi-container { display: flex; justify-content: center; margin-bottom: 30px; }
        .gauge-outer { width: 160px; height: 160px; border-radius: 50%; background: conic-gradient(var(--neon-red) 0deg, rgba(255,255,255,0.05) 0deg); display: flex; justify-content: center; align-items: center; box-shadow: 0 0 30px rgba(0,0,0,0.3); }
        .gauge-inner { width: 130px; height: 130px; background: #0a0f18; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .gauge-value { font-size: 48px; font-weight: 700; color: #fff; line-height: 1; }
        .gauge-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
        .gauge-status { font-size: 16px; font-weight: 600; margin-top: 5px; color: var(--neon-red); }

        /* Sliders */
        .control-group { margin-bottom: 25px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: var(--text-muted); }
        input[type=range] { width: 100%; appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--neon-cyan); margin-top: -6px; cursor: pointer; }

        /* Action Grid */
        .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 15px; border-left: 3px solid var(--neon-cyan); padding-left: 10px; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .action-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: 0.3s; }
        .action-card i { font-size: 18px; color: var(--text-muted); transition: 0.3s; }
        .action-card span { font-size: 13px; font-weight: 600; color: var(--text-muted); }
        .action-card.active { background: rgba(0, 242, 255, 0.1); border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 242, 255, 0.15); }
        .action-card.active i { color: var(--neon-cyan); }
        .action-card.active span { color: #fff; }

        /* Chat */
        #chatBox { background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.05); }
        #chatLog { height: 100px; overflow-y: auto; font-size: 13px; margin-bottom: 10px; color: var(--text-muted); }
        .chat-input-row { display: flex; gap: 8px; }
        #chatInput { flex: 1; background: rgba(255,255,255,0.05); border: none; padding: 8px 12px; color: #fff; border-radius: 6px; outline: none; }
        .btn-send { background: var(--neon-cyan); border: none; cursor: pointer; font-weight: bold; border-radius: 6px; padding: 0 12px; }

    </style>
</head>
<body>

    <div id="cursor"></div>

    <div id="landing-layer">
        <div class="fog-container">
            <div class="fog-img"></div>
            <div class="fog-img-2"></div>
        </div>
        
        <div class="landing-ui">
            <div style="font-size: 14px; letter-spacing: 4px; color: #888; margin-bottom: 10px;">CDH DELHI PRESENTS</div>
            <h1 class="main-header">TWINX</h1>
            <button id="initBtn" class="init-btn" onclick="initializeSystem()">INITIALIZE SIMULATOR</button>
        </div>
        <div class="loader-container"><div class="loader-bar"><div class="loader-progress"></div></div><div class="boot-text"></div></div>
    </div>

    <div class="top-nav" style="display:none;" id="mainNav">
        <button class="nav-btn cost-btn" onclick="openAudit()"><i class="fas fa-file-invoice-dollar"></i> üí∞ Cost Analysis</button>
        <div class="cesium-viewer-geocoderContainer"></div> </div>

    <div id="auditModal">
        <div class="audit-paper">
            <span class="close-audit" onclick="closeAudit()">&times;</span>
            <div class="audit-header">
                <h2>GOVT. EXPENDITURE REPORT</h2>
                <p>DEPARTMENT OF ENVIRONMENT</p>
                <p>DATE: <span id="auditDate"></span></p>
            </div>
            <table class="audit-table">
                <thead>
                    <tr>
                        <th>ITEM</th>
                        <th>QTY/DUR</th>
                        <th>COST (INR)</th>
                    </tr>
                </thead>
                <tbody id="auditList"></tbody>
            </table>
            <div class="audit-total">
                <span>GRAND TOTAL:</span>
                <span id="auditTotal" style="color:#d32f2f">‚Çπ0.00</span>
            </div>
            <div id="auditStatus" class="audit-status"></div>
        </div>
    </div>

    <div id="dashboard-panel">
        <div class="panel-header"><h2 class="panel-title">Policy Engine</h2></div>
        <div class="panel-content" id="panel-content">
            <div class="aqi-container">
                <div class="gauge-outer" id="gaugeOuter">
                    <div class="gauge-inner">
                        <div class="gauge-value" id="aqiDisplay">450</div>
                        <div class="gauge-label">Global AQI</div>
                        <div class="gauge-status" id="aqiStatus">Severe</div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="label-row"><span>Wind Dispersion</span> <span>High</span></div>
                <input type="range" id="speedSlider" min="1" max="100" value="10">
            </div>
            <div class="section-title">Countermeasures</div>
            <div class="action-grid" id="policyGrid"></div>
            <div class="section-title">Live Sensor Network</div>
            <div id="impactDesc" style="font-size:12px; color:var(--neon-cyan); margin-bottom:10px;">5 DPCC Stations Online.</div>
            <div id="chatBox">
                <div id="chatLog">Gemini: Describe a scenario.</div>
                <div class="chat-input-row">
                    <input type="text" id="chatInput" placeholder="Command...">
                    <button class="btn-send" onclick="sendToAI()">></button>
                </div>
            </div>
        </div>
    </div>

    <div id="cesiumContainer"></div>

    <script>
        // --- 1. DATA (COST & SENSORS) ---
        const POLICY_COSTS = {
            "smog_tower": { label: "Install Smog Tower", unit_cost: 220000000, monthly_opex: 1500000, type: "infrastructure", qty: 1 },
            "anti_smog_gun": { label: "Anti-Smog Gun", unit_cost: 0, monthly_opex: 60000, type: "rental", qty: 200 },
            "mech_sweeper": { label: "Mech. Road Sweeper", unit_cost: 5000000, monthly_opex: 150000, type: "fleet", qty: 50 },
            "odd_even": { label: "Odd-Even Scheme", unit_cost: 0, monthly_opex: 200000000, type: "policy", qty: 1 },
            "construction_ban": { label: "Worker Compensation", unit_cost: 0, monthly_opex: 2500000000, type: "welfare", qty: 1 }
        };

        const dpccStationData = [
          { id: "DPCC-001", lat: 28.6469, lng: 77.3160, baseAqi: 485, color: '#ff3300', size: 25, type: "Hotspot" },
          { id: "DPCC-002", lat: 28.5632, lng: 77.1869, baseAqi: 390, color: '#aaaaaa', size: 15, type: "Residential" },
          { id: "DPCC-003", lat: 28.5306, lng: 77.2714, baseAqi: 440, color: '#ff5500', size: 22, type: "Industrial" },
          { id: "DPCC-004", lat: 28.6619, lng: 77.1242, baseAqi: 410, color: '#ff8800', size: 20, type: "Traffic" },
          { id: "DPCC-005", lat: 28.7324, lng: 77.1706, baseAqi: 465, color: '#ff3300', size: 24, type: "Congested" }
        ];

        // Maps UI keys to Cost Keys
        const POLICY_UI_CONFIG = {
            "odd_even": { label: "Odd-Even Scheme", impact: 15, icon: "fa-car-side", costKey: "odd_even" },
            "construction_ban": { label: "Construction Ban", impact: 45, icon: "fa-trowel-bricks", costKey: "construction_ban" },
            "smog_tower": { label: "Run Smog Tower", impact: 5, icon: "fa-fan", costKey: "smog_tower" },
            "mech_sweeper": { label: "Mech. Sweeping", impact: 10, icon: "fa-truck-monster", costKey: "mech_sweeper" },
            "anti_smog_gun": { label: "Anti-Smog Guns", impact: 8, icon: "fa-shower", costKey: "anti_smog_gun" }
        };

        const State = { aqi: 450, baseAqi: 450, activePolicies: new Set(), windSpeed: 10, emitters: [] };

        // --- 2. LOGIC ---
        function generatePolicies() {
            const grid = document.getElementById('policyGrid');
            grid.innerHTML = '';
            for (const [key, data] of Object.entries(POLICY_UI_CONFIG)) {
                const card = document.createElement('div');
                card.className = 'action-card';
                card.id = `card_${key}`;
                card.onclick = () => togglePolicy(key, card);
                card.innerHTML = `<i class="fas ${data.icon}"></i><span>${data.label}</span>`;
                grid.appendChild(card);
            }
        }

        function togglePolicy(key, card) {
            State.activePolicies.has(key) ? State.activePolicies.delete(key) : State.activePolicies.add(key);
            card.classList.toggle('active');
            recalcImpact();
        }

        function recalcImpact() {
            let totalReduction = 0;
            State.activePolicies.forEach(key => totalReduction += POLICY_UI_CONFIG[key].impact);
            State.aqi = Math.max(50, State.baseAqi - totalReduction);
            
            const pct = (State.aqi/500)*100;
            let color = State.aqi > 200 ? '#ff003c' : (State.aqi > 100 ? '#ff9900' : '#00ff88');
            
            document.getElementById('aqiDisplay').innerText = Math.round(State.aqi);
            document.getElementById('aqiStatus').innerText = State.aqi > 300 ? "Severe" : (State.aqi > 100 ? "Poor" : "Moderate");
            document.getElementById('aqiStatus').style.color = color;
            document.getElementById('gaugeOuter').style.background = `conic-gradient(${color} ${pct*3.6}deg, rgba(255,255,255,0.05) 0deg)`;
            
            updateVisuals();
        }

        document.getElementById('speedSlider').oninput = (e) => {
            State.windSpeed = parseInt(e.target.value);
            updateVisuals();
        };

        // --- 3. AUDIT LOGIC ---
        function openAudit() {
            const modal = document.getElementById('auditModal');
            const list = document.getElementById('auditList');
            const totalEl = document.getElementById('auditTotal');
            const statusEl = document.getElementById('auditStatus');
            document.getElementById('auditDate').innerText = new Date().toLocaleDateString();
            list.innerHTML = '';
            let grandTotal = 0;

            if(State.activePolicies.size === 0) {
                list.innerHTML = '<tr><td colspan="3" style="text-align:center;">NO ACTIVE POLICIES</td></tr>';
            } else {
                State.activePolicies.forEach(uiKey => {
                    const costKey = POLICY_UI_CONFIG[uiKey].costKey;
                    const costData = POLICY_COSTS[costKey];
                    if(costData) {
                        let itemTotal = costData.type === "infrastructure" ? (costData.unit_cost * costData.qty) + costData.monthly_opex : (costData.monthly_opex * costData.qty);
                        if (costData.type === "policy" || costData.type === "welfare") itemTotal = costData.monthly_opex;
                        grandTotal += itemTotal;
                        list.innerHTML += `<tr><td>${costData.label}</td><td>${costData.qty} Units/15 Days</td><td>‚Çπ${itemTotal.toLocaleString()}</td></tr>`;
                    }
                });
            }
            totalEl.innerText = `‚Çπ${grandTotal.toLocaleString()}`;
            const BUDGET_LIMIT = 3000000000;
            if (grandTotal < BUDGET_LIMIT) {
                statusEl.innerHTML = "‚úÖ APPROVED<br>Within Dept Budget (‚Çπ506 Cr)";
                statusEl.style.color = "green"; statusEl.style.borderColor = "green"; statusEl.style.background = "#e8f5e9";
            } else {
                statusEl.innerHTML = "‚ö†Ô∏è OVER BUDGET<br>Requires Central Govt. Funds (> ‚Çπ300 Cr)";
                statusEl.style.color = "red"; statusEl.style.borderColor = "red"; statusEl.style.background = "#ffebee";
            }
            modal.style.display = "flex";
        }
        function closeAudit() { document.getElementById('auditModal').style.display = "none"; }

        // --- 4. VISUALS ---
        function createParticleImage() {
            var canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
            var ctx = canvas.getContext('2d');
            var grd = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            grd.addColorStop(0, 'white'); grd.addColorStop(1, 'transparent');
            ctx.fillStyle = grd; ctx.fillRect(0, 0, 64, 64);
            return canvas;
        }

        function setupSmog(viewer) {
            const particleImage = createParticleImage();
            dpccStationData.forEach(station => {
                const position = Cesium.Cartesian3.fromDegrees(station.lng, station.lat, 50);
                const color = Cesium.Color.fromCssColorString(station.color);
                const system = new Cesium.ParticleSystem({
                    image: particleImage,
                    startColor: color.withAlpha(0.6), endColor: color.withAlpha(0.0),
                    startScale: station.size, endScale: station.size * 4,
                    minimumParticleLife: 3.0, maximumParticleLife: 6.0,
                    minimumSpeed: 1.0, maximumSpeed: 4.0,
                    imageSize: new Cesium.Cartesian2(station.size, station.size),
                    emissionRate: 5.0, lifetime: 16.0,
                    emitter: new Cesium.CircleEmitter(300.0),
                    modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(position),
                    updateCallback: (p, dt) => {
                        const windVec = new Cesium.Cartesian3(State.windSpeed * 0.5, State.windSpeed * 0.2, 5.0);
                        Cesium.Cartesian3.add(p.velocity, windVec, p.velocity);
                    }
                });
                viewer.scene.primitives.add(system);
                State.emitters.push({ system, type: station.type, baseRate: 5.0 });
            });
        }

        function setupZonalHeatmap(viewer) {
            dpccStationData.forEach(station => {
                viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(station.lng, station.lat),
                    ellipse: {
                        semiMinorAxis: 2000.0, semiMajorAxis: 2000.0,
                        material: new Cesium.ColorMaterialProperty(new Cesium.CallbackProperty(() => {
                            const globalRatio = State.aqi / State.baseAqi; 
                            const localAqi = station.baseAqi * globalRatio;
                            const factor = Math.min(localAqi / 500, 1.0);
                            const baseColor = Cesium.Color.lerp(Cesium.Color.fromCssColorString('#00ff88'), Cesium.Color.fromCssColorString('#ff003c'), factor, new Cesium.Color());
                            const opacity = Math.max(0.2, 0.6 - (State.windSpeed / 200));
                            return baseColor.withAlpha(opacity);
                        }, false))
                    }
                });
            });
        }

        function updateVisuals() {
            State.emitters.forEach(obj => {
                let rate = obj.baseRate;
                if(State.activePolicies.size > 0) rate *= 0.6;
                const windFactor = Math.max(0.2, 1.0 - (State.windSpeed / 50)); 
                obj.system.emissionRate = rate * windFactor;
            });
        }

        // --- 5. INIT ---
        async function initCesium() {
            Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3MzI3MGIyZS1jZDEwLTRiOTYtOTJjNS1mZTFlOGVkNDg4NzUiLCJpZCI6Mzg1NzcyLCJpYXQiOjE3Njk5NDc2NTJ9.fvUHQUlAGhWQE_8fClYm3sWd0pnmkD7bKYUjQfrA_5g';
            const viewer = new Cesium.Viewer('cesiumContainer', {
                terrainProvider: await Cesium.createWorldTerrainAsync(),
                baseLayerPicker: false, animation: false, timeline: false, 
                selectionIndicator: false, infoBox: false, geocoder: true, homeButton: false, sceneModePicker: false
            });
            viewer.scene.primitives.add(await Cesium.createOsmBuildingsAsync());
            viewer.scene.fog.enabled = true;
            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(77.2, 28.6, 15000), orientation: { pitch: Cesium.Math.toRadians(-60) } });
            window.viewer = viewer;
            setupSmog(viewer);
            setupZonalHeatmap(viewer);
        }

        function initializeSystem() {
            gsap.to(".init-btn", { opacity: 0, pointerEvents: "none" });
            gsap.to(".main-header", { opacity: 0, scale: 1.5, filter: "blur(20px)" });
            document.querySelector('.loader-container').style.display = 'block';
            const tl = gsap.timeline({onComplete: revealDashboard});
            tl.to(".loader-progress", {width: "100%", duration: 2, ease: "power2.inOut"})
              .to(".boot-text", {text: "CONNECTING SENSORS...", duration: 1}, "<");
        }

        function revealDashboard() {
            gsap.to("#landing-layer", {y: "-100%", duration: 1.2, ease: "power4.inOut"});
            document.body.style.cursor = "auto";
            document.getElementById('cursor').style.display = "none";
            gsap.to("#cesiumContainer", {opacity: 1, duration: 1});
            gsap.to("#dashboard-panel", {x: 0, duration: 0.8, delay: 0.5, ease: "back.out(1.2)"});
            document.getElementById('mainNav').style.display = 'flex'; // Show nav
            initCesium(); generatePolicies();
        }

        // --- AI ---
        async function sendToAI() {
            const input = document.getElementById("chatInput");
            const log = document.getElementById("chatLog");
            const userText = input.value.trim();
            if (!userText) return;
            log.innerHTML += `<div style="color:#fff; margin-top:5px;">You: ${userText}</div>`;
            input.value = ""; log.scrollTop = log.scrollHeight;
            const prompt = `User: "${userText}". Actions: [odd_even, construction_ban, smog_tower, mech_sweeper, anti_smog_gun]. JSON: {"recommend": ["odd_even"], "reason": "why"}`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=AIzaSyBrKYHgIkNV-5QhSZmlCaq41y7Wzqp_GA4`, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                const res = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim());
                log.innerHTML += `<div style="color:var(--neon-cyan); margin-top:5px;">DPCC AI: ${res.reason}</div>`;
                res.recommend.forEach(key => {
                    const card = document.getElementById(`card_${key}`);
                    if(card && !card.classList.contains('active')) togglePolicy(key, card);
                });
            } catch (e) { log.innerHTML += `<div style="color:red">AI Error.</div>`; }
            log.scrollTop = log.scrollHeight;
        }

        // Cursor
        const cursor = document.getElementById('cursor');
        document.addEventListener('mousemove', (e) => { cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px'; });
        document.querySelector('.main-header').addEventListener('mouseenter', () => { cursor.style.width = '80px'; cursor.style.height = '80px'; cursor.style.mixBlendMode = 'normal'; cursor.style.borderColor = '#fff'; });
        document.querySelector('.main-header').addEventListener('mouseleave', () => { cursor.style.width = '40px'; cursor.style.height = '40px'; cursor.style.mixBlendMode = 'difference'; cursor.style.borderColor = 'var(--neon-cyan)'; });
    </script>
</body>
</html>